!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.thumbjs=t()}}(function(){function t(){}function e(t,i){return this.identifier=i.identifier,this.position=i.position,this.frontPosition=i.frontPosition,this.collection=t,this.defaults={size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1},this.config(i),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=e.id,e.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}function i(t,e){var o=this;return o.thumbs=[],o.idles=[],o.actives=[],o.ids=[],o.pressureIntervals={},o.manager=t,o.id=i.id,i.id+=1,o.defaults={zone:document.body,multitouch:!1,maxNumberOfThumbs:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,lockX:!1,lockY:!1},o.config(e),"static"!==o.options.mode&&"semi"!==o.options.mode||(o.options.multitouch=!1),o.options.multitouch||(o.options.maxNumberOfThumbs=1),o.updateBox(),o.prepareThumbs(),o.bindings(),o.begin(),o.thumbs}function o(t){var e=this;e.ids={},e.index=0,e.collections=[],e.config(t),e.prepareCollections();var i;return p.bindEvt(window,"resize",function(t){clearTimeout(i),i=setTimeout(function(){var t,i=p.getScroll();e.collections.forEach(function(e){e.forEach(function(e){t=e.el.getBoundingClientRect(),e.position={x:i.x+t.left,y:i.y+t.top}})})},100)}),e.collections}var n,r=!!("ontouchstart"in window),s=!!window.PointerEvent,d=!!window.MSPointerEvent,a={touch:{start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},mouse:{start:"mousedown",move:"mousemove",end:"mouseup"},pointer:{start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"},MSPointer:{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}},c={};s?n=a.pointer:d?n=a.MSPointer:r?(n=a.touch,c=a.mouse):n=a.mouse;var p={};p.distance=function(t,e){var i=e.x-t.x,o=e.y-t.y;return Math.sqrt(i*i+o*o)},p.angle=function(t,e){var i=e.x-t.x,o=e.y-t.y;return p.degrees(Math.atan2(o,i))},p.findCoord=function(t,e,i){var o={x:0,y:0};return i=p.radians(i),o.x=t.x-e*Math.cos(i),o.y=t.y-e*Math.sin(i),o},p.radians=function(t){return t*(Math.PI/180)},p.degrees=function(t){return t*(180/Math.PI)},p.bindEvt=function(t,e,i){for(var o,n=e.split(/[ ,]+/g),r=0;r<n.length;r+=1)o=n[r],t.addEventListener?t.addEventListener(o,i,!1):t.attachEvent&&t.attachEvent(o,i)},p.unbindEvt=function(t,e,i){for(var o,n=e.split(/[ ,]+/g),r=0;r<n.length;r+=1)o=n[r],t.removeEventListener?t.removeEventListener(o,i):t.detachEvent&&t.detachEvent(o,i)},p.trigger=function(t,e,i){var o=new CustomEvent(e,i);t.dispatchEvent(o)},p.prepareEvent=function(t){return t.preventDefault(),t.type.match(/^touch/)?t.changedTouches:t},p.getScroll=function(){return{x:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,y:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}},p.applyPosition=function(t,e){e.top||e.right||e.bottom||e.left?(t.style.top=e.top,t.style.right=e.right,t.style.bottom=e.bottom,t.style.left=e.left):(t.style.left=e.x+"px",t.style.top=e.y+"px")},p.getTransitionStyle=function(t,e,i){var o=p.configStylePropertyObject(t);for(var n in o)if(o.hasOwnProperty(n))if("string"==typeof e)o[n]=e+" "+i;else{for(var r="",s=0,d=e.length;s<d;s+=1)r+=e[s]+" "+i+", ";o[n]=r.slice(0,-2)}return o},p.getVendorStyle=function(t,e){var i=p.configStylePropertyObject(t);for(var o in i)i.hasOwnProperty(o)&&(i[o]=e);return i},p.configStylePropertyObject=function(t){var e={};return e[t]="",["webkit","Moz","o"].forEach(function(i){e[i+t.charAt(0).toUpperCase()+t.slice(1)]=""}),e},p.extend=function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},p.safeExtend=function(t,e){var i={};for(var o in t)t.hasOwnProperty(o)&&e.hasOwnProperty(o)?i[o]=e[o]:t.hasOwnProperty(o)&&(i[o]=t[o]);return i},p.map=function(t,e){if(t.length)for(var i=0,o=t.length;i<o;i+=1)e(t[i]);else e(t)},t.prototype.on=function(t,e){var i,o=this,n=t.split(/[ ,]+/g);o._handlers_=o._handlers_||{};for(var r=0;r<n.length;r+=1)i=n[r],o._handlers_[i]=o._handlers_[i]||[],o._handlers_[i].push(e);return o},t.prototype.off=function(t,e){var i=this;return i._handlers_=i._handlers_||{},void 0===t?i._handlers_={}:void 0===e?i._handlers_[t]=null:i._handlers_[t]&&i._handlers_[t].indexOf(e)>=0&&i._handlers_[t].splice(i._handlers_[t].indexOf(e),1),i},t.prototype.trigger=function(t,e){var i,o=this,n=t.split(/[ ,]+/g);o._handlers_=o._handlers_||{};for(var r=0;r<n.length;r+=1)i=n[r],o._handlers_[i]&&o._handlers_[i].length&&o._handlers_[i].forEach(function(t){t.call(o,{type:i,target:o},e)})},t.prototype.config=function(t){var e=this;e.options=e.defaults||{},t&&(e.options=p.safeExtend(e.options,t))},t.prototype.bindEvt=function(t,e){var i=this;return i._domHandlers_=i._domHandlers_||{},i._domHandlers_[e]=function(){"function"==typeof i["on"+e]?i["on"+e].apply(i,arguments):console.warn('[WARNING] : Missing "on'+e+'" handler.')},p.bindEvt(t,n[e],i._domHandlers_[e]),c[e]&&p.bindEvt(t,c[e],i._domHandlers_[e]),i},t.prototype.unbindEvt=function(t,e){var i=this;return i._domHandlers_=i._domHandlers_||{},p.unbindEvt(t,n[e],i._domHandlers_[e]),c[e]&&p.unbindEvt(t,c[e],i._domHandlers_[e]),delete i._domHandlers_[e],this},e.prototype=new t,e.constructor=e,e.id=0,e.prototype.buildEl=function(t){return this.ui={},this.options.dataOnly?this:(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="thumb collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","thumb_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front),this)},e.prototype.stylize=function(){if(this.options.dataOnly)return this;var t=this.options.fadeTime+"ms",e=p.getVendorStyle("borderRadius","50%"),i=p.getTransitionStyle("transition","opacity",t),o={};return o.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},o.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},o.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5"},p.extend(o.el,i),p.extend(o.back,e),p.extend(o.front,e),this.applyStyles(o),this},e.prototype.applyStyles=function(t){for(var e in this.ui)if(this.ui.hasOwnProperty(e))for(var i in t[e])this.ui[e].style[i]=t[e][i];return this},e.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)?this:(this.options.zone.appendChild(this.ui.el),this)},e.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)?this:(this.options.zone.removeChild(this.ui.el),this)},e.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},e.prototype.show=function(t){var e=this;return e.options.dataOnly?e:(clearTimeout(e.removeTimeout),clearTimeout(e.showTimeout),clearTimeout(e.restTimeout),e.addToDom(),e.restCallback(),setTimeout(function(){e.ui.el.style.opacity=1},0),e.showTimeout=setTimeout(function(){e.trigger("shown",e.instance),"function"==typeof t&&t.call(this)},e.options.fadeTime),e)},e.prototype.hide=function(t){var e=this;return e.options.dataOnly?e:(e.ui.el.style.opacity=e.options.restOpacity,clearTimeout(e.removeTimeout),clearTimeout(e.showTimeout),clearTimeout(e.restTimeout),e.removeTimeout=setTimeout(function(){var i="dynamic"===e.options.mode?"none":"block";e.ui.el.style.display=i,"function"==typeof t&&t.call(e),e.trigger("hidden",e.instance)},e.options.fadeTime),e.options.restJoystick&&e.restPosition(),e)},e.prototype.restPosition=function(t){var e=this;e.frontPosition={x:0,y:0};var i=e.options.fadeTime+"ms",o={};o.front=p.getTransitionStyle("transition",["top","left"],i);var n={front:{}};n.front={left:e.frontPosition.x+"px",top:e.frontPosition.y+"px"},e.applyStyles(o),e.applyStyles(n),e.restTimeout=setTimeout(function(){"function"==typeof t&&t.call(e),e.restCallback()},e.options.fadeTime)},e.prototype.restCallback=function(){var t=this,e={};e.front=p.getTransitionStyle("transition","none",""),t.applyStyles(e),t.trigger("rested",t.instance)},e.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},e.prototype.computeDirection=function(t){var e,i,o,n=t.angle.radian,r=Math.PI/4,s=Math.PI/2;if(n>r&&n<3*r&&!t.lockX?e="up":n>-r&&n<=r&&!t.lockY?e="left":n>3*-r&&n<=-r&&!t.lockX?e="down":t.lockY||(e="right"),t.lockY||(i=n>-s&&n<s?"left":"right"),t.lockX||(o=n>0?"up":"down"),t.force>this.options.threshold){var d={};for(var a in this.direction)this.direction.hasOwnProperty(a)&&(d[a]=this.direction[a]);var c={};this.direction={x:i,y:o,angle:e},t.direction=this.direction;for(var a in d)d[a]===this.direction[a]&&(c[a]=!0);if(c.x&&c.y&&c.angle)return t;c.x&&c.y||this.trigger("plain",t),c.x||this.trigger("plain:"+i,t),c.y||this.trigger("plain:"+o,t),c.angle||this.trigger("dir dir:"+e,t)}return t},i.prototype=new t,i.constructor=i,i.id=0,i.prototype.prepareThumbs=function(){var t=this,e=t.thumbs;e.on=t.on.bind(t),e.off=t.off.bind(t),e.options=t.options,e.destroy=t.destroy.bind(t),e.ids=t.ids,e.id=t.id,e.processOnMove=t.processOnMove.bind(t),e.processOnEnd=t.processOnEnd.bind(t),e.get=function(t){if(void 0===t)return e[0];for(var i=0,o=e.length;i<o;i+=1)if(e[i].identifier===t)return e[i];return!1}},i.prototype.bindings=function(){var t=this;t.bindEvt(t.options.zone,"start"),t.options.zone.style.touchAction="none",t.options.zone.style.msTouchAction="none"},i.prototype.begin=function(){var t=this,e=t.options;if("static"===e.mode){var i=t.createThumb(e.position,t.manager.getIdentifier());i.add(),t.idles.push(i)}},i.prototype.createThumb=function(t,i){var o=this,n=p.getScroll(),r={},s=o.options;if(t.x&&t.y)r={x:t.x-(n.x+o.box.left),y:t.y-(n.y+o.box.top)};else if(t.top||t.right||t.bottom||t.left){var d=document.createElement("DIV");d.style.display="hidden",d.style.top=t.top,d.style.right=t.right,d.style.bottom=t.bottom,d.style.left=t.left,d.style.position="absolute",s.zone.appendChild(d);var a=d.getBoundingClientRect();s.zone.removeChild(d),r=t,t={x:a.left+n.x,y:a.top+n.y}}var c=new e(o,{color:s.color,size:s.size,threshold:s.threshold,fadeTime:s.fadeTime,dataOnly:s.dataOnly,restJoystick:s.restJoystick,restOpacity:s.restOpacity,mode:s.mode,identifier:i,position:t,zone:s.zone,frontPosition:{x:0,y:0}});return s.dataOnly||(p.applyPosition(c.ui.el,r),p.applyPosition(c.ui.front,c.frontPosition)),o.thumbs.push(c),o.trigger("added "+c.identifier+":added",c),o.manager.trigger("added "+c.identifier+":added",c),o.bindThumb(c),c},i.prototype.updateBox=function(){var t=this;t.box=t.options.zone.getBoundingClientRect()},i.prototype.bindThumb=function(t){var e,i=this,o=function(t,o){e=t.type+" "+o.id+":"+t.type,i.trigger(e,o)};t.on("destroyed",i.onDestroyed.bind(i)),t.on("shown hidden rested dir plain",o),t.on("dir:up dir:right dir:down dir:left",o),t.on("plain:up plain:right plain:down plain:left",o)},i.prototype.pressureFn=function(t,e,i){var o=this,n=0;clearInterval(o.pressureIntervals[i]),o.pressureIntervals[i]=setInterval(function(){var i=t.force||t.pressure||t.webkitForce||0;i!==n&&(e.trigger("pressure",i),o.trigger("pressure "+e.identifier+":pressure",i),n=i)}.bind(o),100)},i.prototype.onstart=function(t){var e=this,i=e.options;t=p.prepareEvent(t),e.updateBox();var o=function(t){e.actives.length<i.maxNumberOfThumbs&&e.processOnStart(t)};return p.map(t,o),e.manager.bindDocument(),!1},i.prototype.processOnStart=function(t){var e,i=this,o=i.options,n=i.manager.getIdentifier(t),r=t.force||t.pressure||t.webkitForce||0,s={x:t.pageX,y:t.pageY},d=i.getOrCreate(n,s);d.identifier!==n&&i.manager.removeIdentifier(d.identifier),d.identifier=n;var a=function(e){e.trigger("start",e),i.trigger("start "+e.id+":start",e),e.show(),r>0&&i.pressureFn(t,e,e.identifier),i.processOnMove(t)};if((e=i.idles.indexOf(d))>=0&&i.idles.splice(e,1),i.actives.push(d),i.ids.push(d.identifier),"semi"!==o.mode)a(d);else{if(!(p.distance(s,d.position)<=o.catchDistance))return d.destroy(),void i.processOnStart(t);a(d)}return d},i.prototype.getOrCreate=function(t,e){var i,o=this,n=o.options;return/(semi|static)/.test(n.mode)?(i=o.idles[0])?(o.idles.splice(0,1),i):"semi"===n.mode?o.createThumb(e,t):(console.warn("Coudln't find the needed thumb."),!1):i=o.createThumb(e,t)},i.prototype.processOnMove=function(t){var e=this,i=e.options,o=e.manager.getIdentifier(t),n=e.thumbs.get(o);if(!n)return console.error("Found zombie joystick with ID "+o),void e.manager.removeIdentifier(o);n.identifier=o;var r=n.options.size/2,s={x:t.pageX,y:t.pageY},d=p.distance(s,n.position),a=p.angle(s,n.position),c=p.radians(a),l=d/r;d>r&&(d=r,s=p.findCoord(n.position,d,a));var u=s.x-n.position.x,h=s.y-n.position.y;i.lockX&&(h=0),i.lockY&&(u=0),n.frontPosition={x:u,y:h},i.dataOnly||p.applyPosition(n.ui.front,n.frontPosition);var f={identifier:n.identifier,position:s,force:l,pressure:t.force||t.pressure||t.webkitForce||0,distance:d,angle:{radian:c,degree:a},instance:n,lockX:i.lockX,lockY:i.lockY};f=n.computeDirection(f),f.angle={radian:p.radians(180-a),degree:180-a},n.trigger("move",f),e.trigger("move "+n.id+":move",f)},i.prototype.processOnEnd=function(t){var e=this,i=e.options,o=e.manager.getIdentifier(t),n=e.thumbs.get(o),r=e.manager.removeIdentifier(n.identifier);n&&(i.dataOnly||n.hide(function(){"dynamic"===i.mode&&(n.trigger("removed",n),e.trigger("removed "+n.id+":removed",n),e.manager.trigger("removed "+n.id+":removed",n),n.destroy())}),clearInterval(e.pressureIntervals[n.identifier]),n.resetDirection(),n.trigger("end",n),e.trigger("end "+n.id+":end",n),e.ids.indexOf(n.identifier)>=0&&e.ids.splice(e.ids.indexOf(n.identifier),1),e.actives.indexOf(n)>=0&&e.actives.splice(e.actives.indexOf(n),1),/(semi|static)/.test(i.mode)?e.idles.push(n):e.thumbs.indexOf(n)>=0&&e.thumbs.splice(e.thumbs.indexOf(n),1),e.manager.unbindDocument(),/(semi|static)/.test(i.mode)&&(e.manager.ids[r.id]=r.identifier))},i.prototype.onDestroyed=function(t,e){var i=this;i.thumbs.indexOf(e)>=0&&i.thumbs.splice(i.thumbs.indexOf(e),1),i.actives.indexOf(e)>=0&&i.actives.splice(i.actives.indexOf(e),1),i.idles.indexOf(e)>=0&&i.idles.splice(i.idles.indexOf(e),1),i.ids.indexOf(e.identifier)>=0&&i.ids.splice(i.ids.indexOf(e.identifier),1),i.manager.removeIdentifier(e.identifier),i.manager.unbindDocument()},i.prototype.destroy=function(){var t=this;t.unbindEvt(t.options.zone,"start"),t.thumbs.forEach(function(t){t.destroy()});for(var e in t.pressureIntervals)t.pressureIntervals.hasOwnProperty(e)&&clearInterval(t.pressureIntervals[e]);t.trigger("destroyed",t.thumbs),t.manager.unbindDocument(),t.off()},o.prototype=new t,o.constructor=o,o.prototype.prepareCollections=function(){var t=this;t.collections.create=t.create.bind(t),t.collections.on=t.on.bind(t),t.collections.off=t.off.bind(t),t.collections.destroy=t.destroy.bind(t),t.collections.get=function(e){var i;return t.collections.every(function(t){return!(i=t.get(e))}),i}},o.prototype.create=function(t){return this.createCollection(t)},o.prototype.createCollection=function(t){var e=this,o=new i(e,t);return e.bindCollection(o),e.collections.push(o),o},o.prototype.bindCollection=function(t){var e,i=this,o=function(t,o){e=t.type+" "+o.id+":"+t.type,i.trigger(e,o)};t.on("destroyed",i.onDestroyed.bind(i)),t.on("shown hidden rested dir plain",o),t.on("dir:up dir:right dir:down dir:left",o),t.on("plain:up plain:right plain:down plain:left",o)},o.prototype.bindDocument=function(){var t=this;t.binded||(t.bindEvt(document,"move").bindEvt(document,"end"),t.binded=!0)},o.prototype.unbindDocument=function(t){var e=this;Object.keys(e.ids).length&&!0!==t||(e.unbindEvt(document,"move").unbindEvt(document,"end"),e.binded=!1)},o.prototype.getIdentifier=function(t){var e;return t?void 0===(e=void 0===t.identifier?t.pointerId:t.identifier)&&(e=this.latest||0):e=this.index,void 0===this.ids[e]&&(this.ids[e]=this.index,this.index+=1),this.latest=e,this.ids[e]},o.prototype.removeIdentifier=function(t){var e={};for(var i in this.ids)if(this.ids[i]===t){e.id=i,e.identifier=this.ids[i],delete this.ids[i];break}return e},o.prototype.onmove=function(t){return this.onAny("move",t),!1},o.prototype.onend=function(t){return this.onAny("end",t),!1},o.prototype.oncancel=function(t){return this.onAny("end",t),!1},o.prototype.onAny=function(t,e){var i,o=this,n="processOn"+t.charAt(0).toUpperCase()+t.slice(1);e=p.prepareEvent(e);var r=function(t,e,i){i.ids.indexOf(e)>=0&&(i[n](t),t._found_=!0)},s=function(t){i=o.getIdentifier(t),p.map(o.collections,r.bind(null,t,i)),t._found_||o.removeIdentifier(i)};return p.map(e,s),!1},o.prototype.destroy=function(){var t=this;t.unbindDocument(!0),t.ids={},t.index=0,t.collections.forEach(function(t){t.destroy()}),t.off()},o.prototype.onDestroyed=function(t,e){var i=this;if(i.collections.indexOf(e)<0)return!1;i.collections.splice(i.collections.indexOf(e),1)};var l=new o;return{create:function(t){return l.create(t)},factory:l}});